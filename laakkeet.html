<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lääkemuistio</title>
  <link rel="icon" type="image/png" href="https://img.geocaching.com:443/be1cc7ca-c887-4f38-90b6-813ecf9b342b.png">
  <link rel="apple-touch-icon" href="https://img.geocaching.com:443/be1cc7ca-c887-4f38-90b6-813ecf9b342b.png">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
    { "imports": { "react": "https://esm.sh/react@18.2.0", "react-dom/client": "https://esm.sh/react-dom@18.2.0/client", "lucide-react": "https://esm.sh/lucide-react@0.344.0", "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js", "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js", "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js" } }
  </script>
</head>
<body class="bg-slate-50 text-slate-900 select-none">
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect } from 'react';
    import { createRoot } from 'react-dom/client';
    import { Plus, Pill, Clock, Trash2, CheckCircle, History, X, BarChart2, Calendar, AlertTriangle, Pencil, CalendarPlus, LogOut, User, Lock, Loader2, Archive, ArchiveRestore, ChevronDown, ChevronUp, Sun, Moon, Sunrise, Sunset, Check, Zap, Bell, BellOff, ArrowUpDown, ArrowUp, ArrowDown, HelpCircle, ShoppingCart, FileText, Menu, Copy, Package, RefreshCw } from 'lucide-react';
    import { initializeApp } from 'firebase/app';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from 'firebase/auth';
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot } from 'firebase/firestore';

    const firebaseConfig = { apiKey: "AIzaSyCZIupycr2puYrPK2KajAW7PcThW9Pjhb0", authDomain: "perhekalenteri-projekti.firebaseapp.com", databaseURL: "https://perhekalenteri-projekti-default-rtdb.europe-west1.firebasedatabase.app", projectId: "perhekalenteri-projekti", storageBucket: "perhekalenteri-projekti.appspot.com", messagingSenderId: "588536838615", appId: "1:588536838615:web:148de0581bbd46c42c7392" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const APP_ID = 'laakemuistio';

    // --- UILib ---
    const TIME_SLOTS = [{id:'aamu',l:'Aamu',i:Sunrise,t:'08:00'},{id:'paiva',l:'Päivä',i:Sun,t:'12:00'},{id:'ilta',l:'Ilta',i:Sunset,t:'20:00'},{id:'yo',l:'Yö',i:Moon,t:'22:00'}];
    const COLORS = ['blue','green','purple','orange','rose','cyan','amber','teal','indigo','lime','fuchsia','slate'];
    const getColor = (k) => {
      const m={blue:{bg:'bg-blue-100',b:'border-blue-300',d:'bg-blue-600',t:'text-blue-800',btn:'bg-blue-600'},green:{bg:'bg-green-100',b:'border-green-300',d:'bg-green-600',t:'text-green-800',btn:'bg-green-600'},purple:{bg:'bg-purple-100',b:'border-purple-300',d:'bg-purple-600',t:'text-purple-800',btn:'bg-purple-600'},orange:{bg:'bg-orange-100',b:'border-orange-300',d:'bg-orange-500',t:'text-orange-800',btn:'bg-orange-500'},rose:{bg:'bg-red-100',b:'border-red-300',d:'bg-red-600',t:'text-red-800',btn:'bg-red-600'},cyan:{bg:'bg-cyan-100',b:'border-cyan-300',d:'bg-cyan-600',t:'text-cyan-800',btn:'bg-cyan-600'},amber:{bg:'bg-amber-100',b:'border-amber-300',d:'bg-amber-500',t:'text-amber-800',btn:'bg-amber-500'},teal:{bg:'bg-teal-100',b:'border-teal-300',d:'bg-teal-600',t:'text-teal-800',btn:'bg-teal-600'},indigo:{bg:'bg-indigo-100',b:'border-indigo-300',d:'bg-indigo-600',t:'text-indigo-800',btn:'bg-indigo-600'},lime:{bg:'bg-lime-100',b:'border-lime-300',d:'bg-lime-600',t:'text-lime-800',btn:'bg-lime-600'},fuchsia:{bg:'bg-fuchsia-100',b:'border-fuchsia-300',d:'bg-fuchsia-600',t:'text-fuchsia-800',btn:'bg-fuchsia-600'},slate:{bg:'bg-slate-200',b:'border-slate-300',d:'bg-slate-600',t:'text-slate-800',btn:'bg-slate-600'}};
      return m[k] || m.blue;
    };

    const Button = ({ onClick, children, variant='primary', className='', disabled=false, title='' }) => {
      const base = "py-3 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2";
      const vars = { primary: "bg-blue-600 text-white shadow-md", secondary: "bg-slate-100 text-slate-600", danger: "bg-red-50 text-red-500", ghost: "bg-transparent text-slate-400 hover:text-slate-600", orange: "bg-orange-500 text-white" };
      return <button onClick={onClick} disabled={disabled} title={title} className={`${base} ${vars[variant]} ${className}`}>{children}</button>;
    };
    const Input = (props) => <input {...props} className={`w-full bg-slate-50 p-3 rounded-xl border outline-none focus:border-blue-500 ${props.className}`} />;
    const Modal = ({ children, onClose }) => (
      <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center animate-in fade-in p-4">
        <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 max-h-[90vh] overflow-y-auto">{children}</div>
      </div>
    );

    // --- Sub-Views ---
    const HelpView = ({ onClose }) => (
      <div className="fixed inset-0 z-[60] bg-slate-50 flex flex-col animate-in slide-in-from-right"><div className="bg-white px-4 py-4 border-b flex justify-between items-center"><div className="flex items-center gap-2 text-blue-600 font-bold text-lg"><HelpCircle /> Ohjeet</div><button onClick={onClose} className="p-2 bg-slate-100 rounded-full"><X size={20}/></button></div><div className="flex-1 overflow-y-auto p-5 space-y-6 pb-20">
          <section><h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Pill className="text-blue-500"/> Varasto & Kuurit</h3><div className="bg-white p-4 rounded-xl shadow-sm border text-sm text-slate-600"><p>Voit asettaa hälytysrajan varastolle. Kuurit eivät hälytä loppuessaan.</p></div></section>
          <section><h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><ShoppingCart className="text-green-500"/> Ostoslista</h3><div className="bg-white p-4 rounded-xl shadow-sm border text-sm text-slate-600"><p>Näyttää lääkkeet, jotka ovat alle hälytysrajan.</p></div></section>
          <section><h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><FileText className="text-purple-500"/> Raportti</h3><div className="bg-white p-4 rounded-xl shadow-sm border text-sm text-slate-600"><p>Yhteenveto lääkärille viimeisen 30pv ajalta.</p></div></section>
      </div></div>
    );
    const ShoppingListView = ({ meds, onClose }) => {
      const list = meds.filter(m => !m.isArchived && m.trackStock && !m.isCourse && m.stock <= (m.lowStockLimit || 10));
      return (<div className="fixed inset-0 z-[60] bg-slate-50 flex flex-col animate-in slide-in-from-right"><div className="bg-white px-4 py-4 border-b flex justify-between items-center"><div className="flex items-center gap-2 text-green-700 font-bold text-lg"><ShoppingCart/> Apteekkiin</div><button onClick={onClose} className="p-2 bg-slate-100 rounded-full"><X size={20}/></button></div><div className="flex-1 overflow-y-auto p-5 pb-20">{list.length===0?<div className="text-center text-slate-400 mt-10">Ei ostettavaa!</div>:list.map(m=><div key={m.id} className="bg-white p-4 rounded-xl shadow-sm border border-red-100 flex justify-between mb-2"><div><h3 className="font-bold text-slate-800">{m.name}</h3><p className="text-xs text-red-500">{m.stock} kpl jäljellä</p></div></div>)}</div></div>);
    };
    const ReportView = ({ meds, logs, onClose }) => {
      const [txt, setTxt] = useState('');
      useEffect(() => {
        const d = new Date(); d.setDate(d.getDate()-30);
        const rel = logs.filter(l=>new Date(l.timestamp)>=d);
        let t = `RAPORTTI ${d.toLocaleDateString()}-${new Date().toLocaleDateString()}\n\n`;
        const s = {}; rel.forEach(l=>{const n=meds.find(m=>m.id===l.medId)?.name||l.medName||'?'; s[n]=(s[n]||0)+1;});
        Object.keys(s).sort().forEach(k=>t+=`- ${k}: ${s[k]} krt\n`);
        setTxt(t);
      }, [logs, meds]);
      return (<div className="fixed inset-0 z-[60] bg-slate-50 flex flex-col animate-in slide-in-from-right"><div className="bg-white px-4 py-4 border-b flex justify-between items-center"><div className="flex items-center gap-2 text-purple-700 font-bold text-lg"><FileText/> Raportti</div><button onClick={onClose} className="p-2 bg-slate-100 rounded-full"><X size={20}/></button></div><div className="p-5 flex-1"><textarea readOnly value={txt} className="w-full h-64 p-4 border rounded-xl text-sm font-mono mb-4"/><Button onClick={()=>{navigator.clipboard.writeText(txt);alert("Kopioitu!");}} variant="primary"><Copy size={18}/> Kopioi</Button></div></div>);
    };

    // --- Main Components ---
    const AuthScreen = () => {
      const [isReg, setIsReg] = useState(false); const [e, setE] = useState(''); const [p, setP] = useState(''); const [err, setErr] = useState(''); const [load, setLoad] = useState(false);
      const authAct = async (ev) => { ev.preventDefault(); setErr(''); setLoad(true); try { await setPersistence(auth, browserLocalPersistence); if(isReg) await createUserWithEmailAndPassword(auth,e,p); else await signInWithEmailAndPassword(auth,e,p); } catch(x) { setErr("Virhe kirjautumisessa."); } setLoad(false); };
      return (
        <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50 relative overflow-hidden">
           <div className="absolute inset-0 flex items-center justify-center z-0 pointer-events-none"><img src="https://img.geocaching.com/be1cc7ca-c887-4f38-90b6-813ecf9b342b.png" className="w-3/4 opacity-[0.15] grayscale"/></div>
           <div className="w-full max-w-sm bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl z-10 border border-white">
             <h2 className="text-2xl font-bold text-center mb-6">{isReg?'Luo tunnus':'Kirjaudu'}</h2>
             {err && <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm">{err}</div>}
             <form onSubmit={authAct} className="space-y-4">
               <div className="relative"><User className="absolute left-3 top-3 text-slate-400" size={18}/><input type="email" required className="w-full pl-10 pr-4 py-3 bg-slate-50 border rounded-xl" placeholder="Sähköposti" value={e} onChange={v=>setE(v.target.value)}/></div>
               <div className="relative"><Lock className="absolute left-3 top-3 text-slate-400" size={18}/><input type="password" required className="w-full pl-10 pr-4 py-3 bg-slate-50 border rounded-xl" placeholder="Salasana" value={p} onChange={v=>setP(v.target.value)}/></div>
               <Button type="submit" className="w-full" disabled={load}>{load?<Loader2 className="animate-spin"/>:(isReg?'Rekisteröidy':'Kirjaudu')}</Button>
             </form>
             <button onClick={()=>setIsReg(!isReg)} className="w-full mt-6 text-sm text-blue-600 font-medium">{isReg?'Onko tunnus jo? Kirjaudu':'Luo uusi tunnus'}</button>
           </div>
        </div>
      );
    };

    const MedicineTracker = () => {
      const [tab, setTab] = useState('home');
      const [user, setUser] = useState(null);
      const [meds, setMeds] = useState([]);
      const [logs, setLogs] = useState([]);
      const [notifs, setNotifs] = useState(false);
      const [reorder, setReorder] = useState(false);
      const [expand, setExpand] = useState(null);
      
      // Modals State
      const [view, setView] = useState(null); // 'help', 'shop', 'report'
      const [menu, setMenu] = useState(false);
      const [addM, setAddM] = useState(false);
      const [quickM, setQuickM] = useState(false);
      const [editM, setEditM] = useState(null);
      const [takeM, setTakeM] = useState(null);
      const [editL, setEditL] = useState(null);
      const [histM, setHistM] = useState(null);
      const [delD, setDelD] = useState({open:false});

      // Form States
      const [form, setForm] = useState({});
      const [note, setNote] = useState('');

      useEffect(() => onAuthStateChanged(auth, u => setUser(u)), []);
      useEffect(() => {
        if(!user) return;
        const um = collection(db,'artifacts',APP_ID,'users',user.uid,'medications');
        const ul = collection(db,'artifacts',APP_ID,'users',user.uid,'logs');
        const u1 = onSnapshot(um, s => setMeds(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.order??a.createdAt)-(b.order??b.createdAt))));
        const u2 = onSnapshot(ul, s => setLogs(s.docs.map(d=>({id:d.id,...d.data()}))));
        return () => { u1(); u2(); };
      }, [user]);

      // Notifications
      const reqNotif = () => Notification.requestPermission().then(p => { if(p==='granted') { setNotifs(true); new Notification("Muistutukset päällä!"); } });
      useEffect(() => {
        if(!notifs) return;
        const iv = setInterval(() => {
           const time = new Date().toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'});
           meds.forEach(m => {
             if(m.isArchived || !m.scheduleTimes) return;
             Object.entries(m.scheduleTimes).forEach(([sid, t]) => {
               if(t===time && !logs.some(l=>l.medId===m.id && l.slot===sid && new Date(l.timestamp).toDateString()===new Date().toDateString())) {
                 new Notification(`Ota lääke: ${m.name}`);
               }
             });
           });
        }, 60000);
        return () => clearInterval(iv);
      }, [notifs, meds, logs]);

      // Logic
      const smartColor = () => {
        const used = new Set(meds.filter(m=>!m.isArchived).map(m=>m.colorKey));
        return COLORS.find(c=>!used.has(c)) || COLORS[meds.length%COLORS.length];
      };
      
      const saveMed = async (isNew) => {
        if(!form.name) return;
        const d = { name: form.name, dosage: form.dosage||'', stock: form.trackStock?parseInt(form.stock)||0:null, trackStock: form.trackStock||false, lowStockLimit: form.lowLimit||10, isCourse: form.isCourse||false, colorKey: form.color, schedule: form.schedule||[], scheduleTimes: form.times||{}, isArchived: false };
        if(isNew) {
           d.createdAt = Date.now(); d.order = meds.length+1;
           await addDoc(collection(db,'artifacts',APP_ID,'users',user.uid,'medications'), d);
           setAddM(false);
        } else {
           await updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'medications', editM.id), d);
           setEditM(null);
        }
      };

      const doTake = async () => {
        const {m, sid} = takeM;
        await addDoc(collection(db,'artifacts',APP_ID,'users',user.uid,'logs'), { medId:m.id, medName:m.name, medColor:m.colorKey, slot:sid, note:note, timestamp:new Date().toISOString() });
        if(m.trackStock && m.stock > 0) await updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'medications',m.id), {stock: m.stock-1});
        setTakeM(null); setNote('');
      };

      const doQuick = async () => {
        if(!form.quick) return;
        await addDoc(collection(db,'artifacts',APP_ID,'users',user.uid,'logs'), { medId:'quick', medName:form.quick, medColor:'orange', timestamp:new Date().toISOString() });
        setQuickM(false);
      };

      const doManual = async () => {
         if(!form.manDate) return;
         await addDoc(collection(db,'artifacts',APP_ID,'users',user.uid,'logs'), { medId:takeM.id, medName:takeM.name, medColor:takeM.colorKey, timestamp:new Date(form.manDate).toISOString() });
         if(takeM.trackStock) await updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'medications',takeM.id), {stock: takeM.stock-1});
         setTakeM(null);
      };

      const doDelMed = async (keepHist) => {
        await deleteDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'medications',delD.mid));
        if(!keepHist) {
           const ls = logs.filter(l=>l.medId===delD.mid);
           ls.forEach(l => deleteDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'logs',l.id)));
        } else {
           // Ensure history has names
           const m = meds.find(x=>x.id===delD.mid);
           const ls = logs.filter(l=>l.medId===delD.mid && !l.medName);
           ls.forEach(l => updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'logs',l.id), {medName: m.name, medColor: m.colorKey}));
        }
        setDelD({open:false}); setHistM(null);
      };

      const doDelLog = async () => {
        await deleteDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'logs',delD.lid));
        setDelD({open:false}); setEditL(null);
      };

      const move = async (idx, dir) => {
         const acts = meds.filter(m=>!m.isArchived);
         if(idx+dir<0 || idx+dir>=acts.length) return;
         const a=acts[idx], b=acts[idx+dir];
         let o1=a.order??a.createdAt, o2=b.order??b.createdAt;
         if(o1===o2) o2++;
         await updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'medications',a.id),{order:o2});
         await updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'medications',b.id),{order:o1});
      };

      const getProgress = () => {
        const sched = meds.filter(m=>!m.isArchived && m.schedule?.length);
        if(!sched.length) return 0;
        let tot=0, ok=0; const today=new Date().toDateString();
        sched.forEach(m => m.schedule.forEach(s => { tot++; if(logs.some(l=>l.medId===m.id && l.slot===s && new Date(l.timestamp).toDateString()===today)) ok++; }));
        return tot===0?0:Math.round((ok/tot)*100);
      };

      // Renders
      const activeMeds = meds.filter(m=>!m.isArchived);
      const archMeds = meds.filter(m=>m.isArchived);

      if(!user) return <AuthScreen />;

      return (
        <div className="flex flex-col h-screen bg-slate-50 relative font-sans">
           <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-0"><img src="https://img.geocaching.com/be1cc7ca-c887-4f38-90b6-813ecf9b342b.png" className="w-3/4 opacity-[0.15] grayscale"/></div>
           
           <header className="bg-white/95 backdrop-blur border-b px-4 py-3 z-10 shadow-sm">
             <div className="flex justify-between items-center mb-3">
               <div className="flex items-center gap-3"><img src="https://img.geocaching.com/be1cc7ca-c887-4f38-90b6-813ecf9b342b.png" className="h-8"/> <h1 className="text-lg font-bold text-slate-800">Lääkemuistio</h1></div>
               <div className="flex gap-2">
                 <button onClick={()=>setReorder(!reorder)} className={`p-2 rounded-full ${reorder?'bg-blue-100 text-blue-600':'text-slate-400'}`}><ArrowUpDown size={20}/></button>
                 <button onClick={()=>setMenu(!menu)} className="p-2 text-slate-400"><Menu/></button>
               </div>
             </div>
             {menu && <div className="absolute right-4 top-14 bg-white rounded-xl shadow-xl border p-2 z-50 w-48 flex flex-col gap-1">
                 <button onClick={()=>{setView('shop');setMenu(false)}} className="flex gap-2 p-3 hover:bg-slate-50 text-sm font-bold text-slate-700"><ShoppingCart size={18} className="text-green-600"/> Ostoslista</button>
                 <button onClick={()=>{setView('report');setMenu(false)}} className="flex gap-2 p-3 hover:bg-slate-50 text-sm font-bold text-slate-700"><FileText size={18} className="text-purple-600"/> Raportti</button>
                 <button onClick={()=>{setView('help');setMenu(false)}} className="flex gap-2 p-3 hover:bg-slate-50 text-sm font-bold text-slate-700"><HelpCircle size={18} className="text-blue-600"/> Ohjeet</button>
                 <div className="h-px bg-slate-100 my-1"/>
                 <button onClick={()=>signOut(auth)} className="flex gap-2 p-3 text-red-600 text-sm font-bold"><LogOut size={18}/> Kirjaudu ulos</button>
             </div>}
             <div className="bg-slate-100 p-1 rounded-xl flex mb-1">
               <button onClick={()=>setTab('home')} className={`flex-1 py-2 rounded-lg text-sm font-bold flex justify-center gap-2 ${tab==='home'?'bg-white text-blue-600 shadow-sm':'text-slate-500'}`}><Pill size={16}/> Lääkkeet</button>
               <button onClick={()=>setTab('stats')} className={`flex-1 py-2 rounded-lg text-sm font-bold flex justify-center gap-2 ${tab==='stats'?'bg-white text-blue-600 shadow-sm':'text-slate-500'}`}><BarChart2 size={16}/> Historia</button>
             </div>
             {tab==='home' && !reorder && getProgress()>0 && <div className="mt-2 w-full bg-slate-100 rounded-full h-1.5"><div className="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style={{width:`${getProgress()}%`}}></div></div>}
           </header>

           <main className="flex-1 overflow-y-auto p-3 pb-20 z-10 relative">
             <div className="max-w-md mx-auto space-y-3">
                {tab==='home' && activeMeds.map((m,i) => {
                  const c = getColor(m.colorKey);
                  const isExp = expand === m.id || reorder;
                  const last = logs.filter(l=>l.medId===m.id).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))[0];
                  const low = m.trackStock && !m.isCourse && m.stock <= (m.lowStockLimit||10);
                  const done = m.schedule?.length ? m.schedule.every(s=>logs.some(l=>l.medId===m.id && l.slot===s && new Date(l.timestamp).toDateString()===new Date().toDateString())) : logs.some(l=>l.medId===m.id && new Date(l.timestamp).toDateString()===new Date().toDateString());

                  return (
                    <div key={m.id} className={`rounded-xl shadow-sm border overflow-hidden ${c.bg} ${c.border} relative group`}>
                       {reorder && <div className="absolute right-0 top-0 bottom-0 w-14 flex flex-col justify-center gap-2 pr-2 bg-white/50 z-30"><button onClick={(e)=>{e.stopPropagation();move(i,-1)}} disabled={i===0} className="p-2 bg-white rounded-full shadow"><ArrowUp size={16}/></button><button onClick={(e)=>{e.stopPropagation();move(i,1)}} disabled={i===activeMeds.length-1} className="p-2 bg-white rounded-full shadow"><ArrowDown size={16}/></button></div>}
                       <div onClick={()=>!reorder&&setExpand(isExp?null:m.id)} className={`p-4 flex justify-between items-center ${!reorder?'cursor-pointer':''}`}>
                          <div className="flex-1 pr-2">
                             <div className="flex items-center gap-2"><h3 className="text-lg font-bold text-slate-800">{m.name}</h3>{!isExp && done && <CheckCircle size={18} className="text-green-600"/>}{!isExp && low && <AlertTriangle size={18} className="text-red-500"/>}</div>
                             {!isExp && <div className="text-xs mt-1 text-slate-500">{low ? <span className="text-red-600 font-bold">Osta lisää! ({m.stock})</span> : m.isCourse ? `Kuuri: ${m.stock} jäljellä` : last ? `Viimeksi: ${new Date(last.timestamp).toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}` : m.dosage || 'Ei otettu'}</div>}
                          </div>
                          {!reorder && <div className="text-slate-400">{isExp?<ChevronUp/>:<ChevronDown/>}</div>}
                       </div>
                       {isExp && !reorder && (
                         <div className="px-4 pb-4 pt-0 animate-in slide-in-from-top-2">
                           <div className="border-t border-black/5 mb-3 pt-1"/>
                           {m.dosage && <div className="text-sm bg-white/50 p-2 rounded inline-block mr-2 mb-2">{m.dosage}</div>}
                           {m.trackStock && <div className={`text-sm bg-white/50 p-2 rounded inline-flex items-center gap-2 mb-2 ${low?'text-red-600 border border-red-200':''}`}><Package size={14}/> {m.stock} kpl</div>}
                           <div className="flex gap-2 mb-4 justify-end flex-wrap">
                             {m.trackStock && <Button variant="ghost" onClick={()=>handleRefill(m)}><RefreshCw size={18}/></Button>}
                             <Button variant="ghost" onClick={()=>{setTakeM(m); setForm({manDate:new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0,16)});}}><CalendarPlus size={18}/></Button>
                             <Button variant="ghost" onClick={()=>setHistM(m.id)}><History size={18}/></Button>
                             <Button variant="ghost" onClick={()=>{setForm({name:m.name, dosage:m.dosage, stock:m.stock, trackStock:m.trackStock, lowLimit:m.lowStockLimit, isCourse:m.isCourse, color:m.colorKey, schedule:m.schedule, times:m.scheduleTimes}); setEditM(m);}}><Pencil size={18}/></Button>
                             <Button variant="ghost" onClick={()=>updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'medications',m.id),{isArchived:true})} className="text-orange-500"><Archive size={18}/></Button>
                             <Button variant="ghost" onClick={()=>{setDelD({open:true, mode:'med', mid:m.id, name:m.name, hist:logs.some(l=>l.medId===m.id)})}} className="text-red-500"><Trash2 size={18}/></Button>
                           </div>
                           {m.schedule?.length ? (
                             <div className="grid grid-cols-4 gap-2">
                               {TIME_SLOTS.filter(s=>m.schedule.includes(s.id)).map(s=>{
                                 const t = logs.some(l=>l.medId===m.id && l.slot===s.id && new Date(l.timestamp).toDateString()===new Date().toDateString());
                                 return <button key={s.id} onClick={()=>setTakeM({m, sid:s.id})} disabled={t} className={`flex flex-col items-center justify-center p-2 rounded-lg border ${t?'bg-green-100 text-green-700':'bg-white text-slate-500'}`}>{t?<Check size={20}/>:<s.icon size={20}/>}<span className="text-[10px] font-bold uppercase mt-1">{s.label}</span></button>
                               })}
                             </div>
                           ) : <Button onClick={()=>setTakeM({m, sid:null})} className="w-full"><CheckCircle size={20}/> OTA NYT</Button>}
                         </div>
                       )}
                   </div>
                  );
               })}
               {tab==='home' && archMeds.length>0 && !reorder && <div className="mt-8"><div className="text-sm text-slate-400 px-2 font-medium mb-2">Arkistoitu</div>{archMeds.map(m=><div key={m.id} className="bg-slate-100 rounded-xl p-3 flex justify-between items-center opacity-70 mb-2"><span>{m.name}</span><div className="flex gap-2"><button onClick={()=>updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'medications',m.id),{isArchived:false})} className="p-2 bg-white rounded"><ArchiveRestore size={16}/></button></div></div>)}</div>}
               
               {tab==='stats' && [...new Set(logs.map(l=>new Date(l.timestamp).toDateString()))].sort((a,b)=>new Date(b)-new Date(a)).map((ds,i)=>(
                 <div key={i} className="border-b pb-3 mb-2"><div className="text-xs font-bold text-slate-400 uppercase mb-2">{new Date(ds).toLocaleDateString()}</div>
                   <div className="flex flex-wrap gap-2">{logs.filter(l=>new Date(l.timestamp).toDateString()===ds).sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp)).map(l=>{
                     const m = meds.find(x=>x.id===l.medId); const c = getColor(m?.colorKey || l.medColor || 'blue');
                     return <button key={l.id} onClick={()=>{setEditL(l); setForm({editTime:new Date(new Date(l.timestamp).getTime() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,16)});}} className={`flex items-center gap-2 px-3 py-2 rounded-lg border shadow-sm ${c.bg} ${c.border} text-left`}><div><span className="text-xs font-bold block">{m?.name||l.medName||'?'}</span><span className="text-[10px]">{new Date(l.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>{l.note && <div className="bg-white/50 px-1 rounded text-[10px] italic">"{l.note}"</div>}</button>
                   })}</div>
                 </div>
               ))}
             </div>
           </main>

           {!addM && tab==='home' && !histM && !reorder && (
              <div className="fixed bottom-8 right-5 z-30 flex gap-3 items-end">
                <Button variant="orange" onClick={()=>setQuickM(true)} className="w-12 h-12 rounded-full"><Zap/></Button>
                <Button variant="primary" onClick={()=>{setForm({name:'',dosage:'',stock:'',trackStock:false,lowLimit:10,isCourse:false,color:smartColor(),schedule:[],times:{}}); setAddM(true);}} className="w-14 h-14 rounded-full"><Plus size={32}/></Button>
              </div>
           )}

           {/* --- MODALS --- */}
           {takeM && !form.manDate && <Modal><h2 className="text-xl font-bold mb-2">Kirjaa otto</h2><p className="mb-4">{takeM.m.name}</p><Input autoFocus placeholder="Kommentti (valinnainen)" value={note} onChange={e=>setNote(e.target.value)} className="mb-4"/><div className="flex gap-2"><Button variant="secondary" onClick={()=>setTakeM(null)} className="flex-1">Peruuta</Button><Button onClick={doTake} className="flex-1">Kirjaa</Button></div></Modal>}
           {takeM && form.manDate && <Modal><h2 className="text-xl font-bold mb-2">Manuaalinen lisäys</h2><p className="mb-4">{takeM.name}</p><Input type="datetime-local" value={form.manDate} onChange={e=>setForm({...form, manDate:e.target.value})} className="mb-4"/><div className="flex gap-2"><Button variant="secondary" onClick={()=>setTakeM(null)} className="flex-1">Peruuta</Button><Button onClick={doManual} className="flex-1">Tallenna</Button></div></Modal>}
           
           {(addM || editM) && <Modal>
              <h2 className="text-lg font-bold mb-4">{editM?'Muokkaa':'Uusi lääke'}</h2>
              <div className="flex flex-wrap gap-2 justify-center mb-4">{COLORS.map(c=><button key={c} onClick={()=>setForm({...form,color:c})} className={`w-8 h-8 rounded-full ${getColor(c).d} ${form.color===c?'ring-2 ring-slate-400':''}`}/>)}</div>
              <Input placeholder="Nimi" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="mb-2"/>
              <Input placeholder="Annostus" value={form.dosage} onChange={e=>setForm({...form,dosage:e.target.value})} className="mb-4"/>
              <div className="bg-slate-50 p-3 rounded-xl mb-4 border"><label className="flex gap-2 mb-2 font-bold text-sm"><input type="checkbox" checked={form.trackStock} onChange={e=>setForm({...form,trackStock:e.target.checked})}/> Varastoseuranta</label>{form.trackStock && <div className="grid grid-cols-2 gap-2"><div><label className="text-[10px] uppercase font-bold text-slate-400">Määrä</label><Input type="number" value={form.stock} onChange={e=>setForm({...form,stock:e.target.value})}/></div><div><label className="text-[10px] uppercase font-bold text-slate-400">Raja</label><Input type="number" value={form.lowLimit} onChange={e=>setForm({...form,lowLimit:e.target.value})}/></div><label className="col-span-2 flex gap-2 text-sm"><input type="checkbox" checked={form.isCourse} onChange={e=>setForm({...form,isCourse:e.target.checked})}/> Tämä on kuuri</label></div>}</div>
              <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Aikataulu</label>
              <div className="grid grid-cols-4 gap-2 mb-6">{TIME_SLOTS.map(s=>{ const sel=(form.schedule||[]).includes(s.id); return <button key={s.id} onClick={()=>{const sch=form.schedule||[]; const nSch=sel?sch.filter(x=>x!==s.id):[...sch,s.id]; const nTm={...form.times}; if(!sel)nTm[s.id]=s.defaultTime; setForm({...form, schedule:nSch, times:nTm});}} className={`p-2 rounded-lg border flex flex-col items-center ${sel?'bg-blue-50 border-blue-500 text-blue-700':'bg-white'}`}><s.icon size={20}/><span className="text-[10px]">{s.label}</span></button>})}</div>
              {/* Kellonajat valituille */}
              {(form.schedule||[]).length > 0 && <div className="grid grid-cols-2 gap-2 mb-4">{(form.schedule).map(sid => <div key={sid} className="text-sm flex items-center gap-2"><span className="uppercase font-bold w-12">{sid}</span><input type="time" value={form.times?.[sid]||''} onChange={e=>setForm({...form, times:{...form.times, [sid]:e.target.value}})} className="border rounded p-1"/></div>)}</div>}
              <div className="flex gap-3"><Button variant="secondary" onClick={()=>{setAddM(false);setEditM(null)}} className="flex-1">Peruuta</Button><Button onClick={()=>saveMed(!!addM)} className="flex-1">Tallenna</Button></div>
           </Modal>}

           {quickM && <Modal><h2 className="text-lg font-bold mb-4 gap-2 flex items-center"><Zap className="text-orange-500"/> Kirjaa kertaotto</h2><Input autoFocus placeholder="Mitä otit? (esim. Burana)" value={form.quick||''} onChange={e=>setForm({...form,quick:e.target.value})} className="mb-4"/><div className="flex gap-3"><Button variant="secondary" onClick={()=>setQuickM(false)} className="flex-1">Peruuta</Button><Button variant="orange" onClick={doQuick} className="flex-1">Kirjaa</Button></div></Modal>}
           
           {editL && <Modal><h2 className="text-lg font-bold mb-2">Muokkaa merkintää</h2><p className="text-sm mb-4">{(meds.find(m=>m.id===editL.medId)?.name || editL.medName)}</p><Input type="datetime-local" value={form.editTime} onChange={e=>setForm({...form,editTime:e.target.value})} className="mb-4"/><div className="flex gap-3 mb-3"><Button variant="secondary" onClick={()=>setEditL(null)} className="flex-1">Peruuta</Button><Button onClick={async ()=>{await updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'logs',editL.id),{timestamp:new Date(form.editTime).toISOString()}); setEditL(null);}} className="flex-1">Tallenna</Button></div><Button onClick={()=>setDelD({open:true, mode:'log', lid:editL.id})} variant="danger" className="w-full"><Trash2 size={16}/> Poista</Button></Modal>}

           {histM && <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur flex items-end justify-center"><div className="bg-white w-full h-[85%] rounded-t-2xl flex flex-col p-4"><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold">{meds.find(m=>m.id===histM)?.name}</h2><button onClick={()=>setHistM(null)} className="p-2 bg-slate-100 rounded-full"><X/></button></div><div className="flex-1 overflow-y-auto space-y-2">{logs.filter(l=>l.medId===histM).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map(l=><div key={l.id} className="p-3 border rounded-xl flex justify-between items-center"><span>{new Date(l.timestamp).toLocaleString()}</span><button onClick={()=>{setEditL(l); setForm({editTime:new Date(new Date(l.timestamp).getTime() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,16)});}} className="text-slate-400"><Pencil size={16}/></button></div>)}</div></div></div>}

           {delD.open && <Modal>
              <div className="flex items-center gap-2 text-red-600 mb-4 font-bold text-lg"><AlertTriangle/> Poistetaanko?</div>
              {delD.mode==='med' ? (delD.hist ? <div className="space-y-2"><Button onClick={()=>doDelMed(true)} className="w-full bg-blue-50 text-blue-600">Säilytä historia</Button><Button onClick={()=>doDelMed(false)} variant="danger" className="w-full">Poista kaikki</Button></div> : <div className="flex gap-2"><Button variant="secondary" onClick={()=>setDelD({open:false})} className="flex-1">Peruuta</Button><Button onClick={()=>doDelMed(false)} variant="danger" className="flex-1">Poista</Button></div>) : <div className="flex gap-2"><Button variant="secondary" onClick={()=>setDelD({open:false})} className="flex-1">Peruuta</Button><Button onClick={doDelLog} variant="danger" className="flex-1">Poista</Button></div>}
           </Modal>}

           {view==='help' && <HelpView onClose={()=>setView(null)}/>}
           {view==='shop' && <ShoppingListView meds={meds} onClose={()=>setView(null)}/>}
           {view==='report' && <ReportView meds={meds} logs={logs} onClose={()=>setView(null)}/>}
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<MedicineTracker />);
  </script>
</body>
</html>
